<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI æ™ºèƒ½å›¾ç‰‡æ–‡å­—è¯†åˆ«æœ—è¯»å·¥å…· (Gemini Enhanced)</title>
    <!-- å¼•å…¥ Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- å¼•å…¥ Tesseract.js -->
    <script src='https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js'></script>
    <!-- å¼•å…¥ Markdown è§£æ (ç”¨äº AI å›å¤æ ¼å¼åŒ–) -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+SC:wght@400;500;700&display=swap');
        body { font-family: 'Noto Sans SC', sans-serif; }
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #f1f1f1; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 4px; }
        ::-webkit-scrollbar-thumb:hover { background: #94a3b8; }
        .drag-active { border-color: #3b82f6; background-color: #eff6ff; }
        /* åŠ è½½åŠ¨ç”» */
        .loader {
            border: 3px solid #f3f3f3;
            border-radius: 50%;
            border-top: 3px solid #3b82f6;
            width: 20px;
            height: 20px;
            -webkit-animation: spin 1s linear infinite; /* Safari */
            animation: spin 1s linear infinite;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .gradient-text {
            background: linear-gradient(to right, #4f46e5, #ec4899);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen flex flex-col items-center py-6 px-4">

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <nav class="w-full max-w-5xl flex justify-between items-center mb-6">
        <div class="flex items-center gap-2">
            <span class="text-2xl">ğŸ“¸</span>
            <h1 class="text-xl font-bold text-gray-800 tracking-tight">AI å›¾æ–‡åŠ©æ‰‹ <span class="text-xs bg-blue-100 text-blue-600 px-2 py-0.5 rounded-full ml-1">Gemini ç‰ˆ</span></h1>
        </div>
        <button onclick="toggleSettings()" class="text-sm bg-white border border-gray-300 hover:bg-gray-50 text-gray-600 px-3 py-1.5 rounded-lg shadow-sm flex items-center gap-2 transition">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543 .826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z" />
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z" />
            </svg>
            API è®¾ç½®
        </button>
    </nav>

    <!-- è®¾ç½®å¼¹çª— -->
    <div id="settingsModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-full max-w-md">
            <h3 class="text-lg font-bold text-gray-800 mb-4">è®¾ç½® Gemini API Key</h3>
            <p class="text-sm text-gray-500 mb-4">
                ä¸ºäº†ä½¿ç”¨ AI çº é”™ã€ç¿»è¯‘å’Œé«˜çº§è¯­éŸ³åŠŸèƒ½ï¼Œè¯·è¾“å…¥æ‚¨çš„ Google Gemini API Keyã€‚
                <br><span class="text-xs text-gray-400">*Key ä»…ä¿å­˜åœ¨æ‚¨çš„æœ¬åœ°æµè§ˆå™¨ä¸­ã€‚</span>
            </p>
            <input type="password" id="apiKeyInput" class="w-full border border-gray-300 rounded-lg px-4 py-2 mb-4 focus:ring-2 focus:ring-blue-500 outline-none" placeholder="åœ¨æ­¤ç²˜è´´æ‚¨çš„ API Key">
            <div class="flex justify-end gap-2">
                <button onclick="toggleSettings()" class="px-4 py-2 text-gray-600 hover:bg-gray-100 rounded-lg">å–æ¶ˆ</button>
                <button onclick="saveApiKey()" class="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700">ä¿å­˜</button>
            </div>
            <div class="mt-4 text-xs text-center text-gray-400">
                è¿˜æ²¡æœ‰ Key? <a href="https://aistudio.google.com/app/apikey" target="_blank" class="text-blue-500 hover:underline">å» Google AI Studio å…è´¹è·å–</a>
            </div>
        </div>
    </div>

    <main class="w-full max-w-5xl bg-white rounded-xl shadow-lg overflow-hidden flex flex-col md:flex-row min-h-[650px]">
        
        <!-- å·¦ä¾§ï¼šå›¾ç‰‡ä¸Šä¼ ä¸ OCR -->
        <div class="w-full md:w-5/12 p-6 border-r border-gray-100 flex flex-col bg-gray-50/30">
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4">1. å›¾ç‰‡æ¥æº</h2>

            <div id="dropZone" class="flex-1 border-2 border-dashed border-gray-300 rounded-xl flex flex-col justify-center items-center p-4 transition-all cursor-pointer hover:border-blue-400 hover:bg-blue-50/50 relative group min-h-[250px]">
                <input type="file" id="fileInput" accept="image/*" class="absolute inset-0 w-full h-full opacity-0 cursor-pointer z-10">
                
                <div id="uploadPrompt" class="text-center transition-opacity duration-300">
                    <div class="mb-3 mx-auto w-14 h-14 bg-white shadow-sm rounded-full flex items-center justify-center text-blue-500 group-hover:scale-110 transition-transform">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-8 w-8" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M4 16l4.586-4.586a2 2 0 012.828 0L16 16m-2-2l1.586-1.586a2 2 0 012.828 0L20 14m-6-6h.01M6 20h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                        </svg>
                    </div>
                    <p class="text-gray-700 font-medium">ç‚¹å‡»æˆ–æ‹–æ‹½ä¸Šä¼ å›¾ç‰‡</p>
                    <p class="text-gray-400 text-xs mt-1">æœ¬åœ°å¤„ç†ï¼Œä¿æŠ¤éšç§</p>
                </div>

                <img id="imagePreview" class="hidden max-h-[300px] w-auto object-contain rounded-lg shadow-sm z-20" alt="Preview">
                <!-- é‡æ–°ä¸Šä¼ è¦†ç›–å±‚ -->
                <div id="reuploadOverlay" class="hidden absolute inset-0 bg-black/40 z-30 rounded-xl flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity">
                    <span class="text-white text-sm font-medium bg-black/50 px-3 py-1 rounded-full backdrop-blur-sm">æ›´æ¢å›¾ç‰‡</span>
                </div>
            </div>

            <!-- è¯†åˆ«æ§åˆ¶ -->
            <div class="mt-5 space-y-3">
                <div class="flex items-center justify-between">
                     <label class="text-xs font-semibold text-gray-500">è¯†åˆ«æ–¹å¼</label>
                     <select id="langSelect" class="border border-gray-200 rounded-md px-2 py-1 text-xs bg-white text-gray-700 focus:outline-none focus:border-blue-500">
                        <option value="chi_sim">ç®€ä½“ä¸­æ–‡ (æœ¬åœ°)</option>
                        <option value="chi_tra">ç¹ä½“ä¸­æ–‡ (æœ¬åœ°)</option>
                        <option value="eng">English Only (æœ¬åœ°)</option>
                        <option value="chi_sim+eng">ä¸­è‹±æ··åˆ (æœ¬åœ°)</option>
                    </select>
                </div>
                
                <div class="grid grid-cols-2 gap-2">
                    <!-- æ–¹å¼ A: æœ¬åœ°è¯†åˆ« -->
                    <button id="recognizeBtn" class="bg-gray-800 hover:bg-gray-900 text-white font-medium py-2.5 px-3 rounded-xl transition shadow-md disabled:bg-gray-300 disabled:cursor-not-allowed flex flex-col justify-center items-center text-sm gap-1" disabled>
                        <div class="flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.75 17L9 20l-1 1h8l-1-1-.75-3M3 13h18M5 17h14a2 2 0 002-2V5a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z" />
                            </svg>
                            æœ¬åœ°è¯†å›¾
                        </div>
                        <span class="text-[10px] text-gray-400 font-normal">å…è´¹/ç¦»çº¿/ç²¾åº¦ä¸€èˆ¬</span>
                    </button>

                    <!-- æ–¹å¼ B: AI è¯†åˆ« -->
                    <button id="aiRecognizeBtn" class="bg-gradient-to-r from-purple-600 to-blue-600 hover:from-purple-700 hover:to-blue-700 text-white font-medium py-2.5 px-3 rounded-xl transition shadow-md disabled:opacity-50 disabled:cursor-not-allowed flex flex-col justify-center items-center text-sm gap-1" disabled>
                        <div class="flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                            </svg>
                            Gemini å¼ºåŠ›è¯†å›¾
                        </div>
                        <span class="text-[10px] text-purple-100 font-normal">è¶…é«˜ç²¾åº¦/éœ€API Key</span>
                    </button>
                </div>

                <!-- è¿›åº¦æ¡ -->
                <div id="progressContainer" class="hidden">
                    <div class="flex justify-between text-xs text-gray-500 mb-1">
                        <span id="statusText">åˆå§‹åŒ–...</span>
                        <span id="progressPercent">0%</span>
                    </div>
                    <div class="w-full bg-gray-200 rounded-full h-1.5 overflow-hidden">
                        <div id="progressBar" class="bg-blue-600 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                    </div>
                </div>
            </div>
        </div>

        <!-- å³ä¾§ï¼šAI å¢å¼ºå·¥ä½œåŒº -->
        <div class="w-full md:w-7/12 p-6 flex flex-col bg-white">
            <h2 class="text-sm font-bold text-gray-500 uppercase tracking-wider mb-4 flex justify-between items-center">
                <span>2. æ™ºèƒ½å¤„ç†ä¸æœ—è¯»</span>
                <span class="text-xs text-blue-600 font-normal bg-blue-50 px-2 py-1 rounded hidden" id="aiBadge">âœ¨ AI åŠŸèƒ½å·²å°±ç»ª</span>
            </h2>

            <!-- æ–‡æœ¬åŒºåŸŸ -->
            <div class="flex-1 relative group">
                <textarea id="resultText" class="w-full h-full p-4 border border-gray-200 bg-gray-50 rounded-xl resize-none focus:bg-white focus:ring-2 focus:ring-blue-100 focus:border-blue-400 outline-none text-gray-700 leading-relaxed text-lg transition-colors" placeholder="OCR è¯†åˆ«ç»“æœå°†å‡ºç°åœ¨è¿™é‡Œ..." spellcheck="false"></textarea>
                
                <!-- å¿«æ·æŒ‰é’®ç»„ -->
                <div class="absolute top-3 right-3 flex gap-1 opacity-0 group-hover:opacity-100 transition-opacity">
                    <button onclick="copyText()" class="bg-white/90 p-1.5 rounded-md shadow-sm border border-gray-200 text-gray-500 hover:text-blue-600 hover:border-blue-300 transition" title="å¤åˆ¶æ–‡æœ¬">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z" />
                        </svg>
                    </button>
                    <button onclick="clearText()" class="bg-white/90 p-1.5 rounded-md shadow-sm border border-gray-200 text-gray-500 hover:text-red-600 hover:border-red-300 transition" title="æ¸…ç©º">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
                        </svg>
                    </button>
                </div>
            </div>

            <!-- åŠŸèƒ½æ§åˆ¶åŒº -->
            <div class="mt-5 space-y-4">
                
                <!-- Gemini AI å·¥å…·æ  -->
                <div class="flex flex-wrap gap-2 pb-4 border-b border-gray-100">
                    <button onclick="aiCorrect()" class="flex-1 min-w-[100px] bg-indigo-50 hover:bg-indigo-100 text-indigo-700 text-sm font-medium py-2 px-3 rounded-lg transition flex items-center justify-center gap-1.5 border border-indigo-200 group relative overflow-hidden">
                         <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                         <span class="relative z-10 flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 5H6a2 2 0 00-2 2v11a2 2 0 002 2h11a2 2 0 002-2v-5m-1.414-9.414a2 2 0 112.828 2.828L11.828 15H9v-2.828l8.586-8.586z" />
                            </svg>
                            AI çº é”™
                         </span>
                    </button>
                    
                    <button onclick="aiTranslate()" class="flex-1 min-w-[100px] bg-purple-50 hover:bg-purple-100 text-purple-700 text-sm font-medium py-2 px-3 rounded-lg transition flex items-center justify-center gap-1.5 border border-purple-200 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        <span class="relative z-10 flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 5h12M9 3v2m1.048 9.5A18.022 18.022 0 016.412 9m6.088 9h7M11 21l5-10 5 10M12.751 5C11.783 10.77 8.07 15.61 3 18.129" />
                            </svg>
                            AI ç¿»è¯‘
                        </span>
                    </button>

                    <button onclick="summarize()" class="flex-1 min-w-[100px] bg-teal-50 hover:bg-teal-100 text-teal-700 text-sm font-medium py-2 px-3 rounded-lg transition flex items-center justify-center gap-1.5 border border-teal-200 group relative overflow-hidden">
                        <div class="absolute inset-0 bg-white/20 translate-y-full group-hover:translate-y-0 transition-transform duration-300"></div>
                        <span class="relative z-10 flex items-center gap-1.5">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h7" />
                            </svg>
                            ç”Ÿæˆæ‘˜è¦
                        </span>
                    </button>
                </div>

                <!-- æœ—è¯»æ§åˆ¶ -->
                <div class="bg-gray-50 p-3 rounded-xl border border-gray-100">
                    <div class="flex items-center gap-2 mb-2">
                        <span class="text-xs font-bold text-gray-500 uppercase">æœ—è¯»å¼•æ“</span>
                        <div class="flex bg-white rounded-lg p-0.5 border border-gray-200 shadow-sm">
                            <button onclick="setEngine('local')" id="engineLocalBtn" class="px-3 py-1 text-xs rounded-md font-medium transition-colors bg-blue-100 text-blue-700">æœ¬åœ°</button>
                            <button onclick="setEngine('ai')" id="engineAiBtn" class="px-3 py-1 text-xs rounded-md font-medium text-gray-500 hover:text-gray-900 transition-colors flex items-center gap-1">
                                <span>Gemini AI</span>
                                <span class="text-[10px] bg-gradient-to-r from-indigo-500 to-pink-500 text-white px-1 rounded-sm">PRO</span>
                            </button>
                        </div>
                    </div>

                    <!-- æœ¬åœ°è¯­éŸ³é€‰æ‹© (é»˜è®¤æ˜¾ç¤º) -->
                    <div id="localVoiceControls">
                        <select id="voiceSelect" class="w-full border border-gray-200 rounded-lg px-2 py-2 text-sm bg-white mb-2">
                            <option value="">åŠ è½½æœ¬åœ°è¯­éŸ³åº“ä¸­...</option>
                        </select>
                    </div>
                    
                    <!-- AI è¯­éŸ³çŠ¶æ€ (é»˜è®¤éšè—) -->
                    <div id="aiVoiceControls" class="hidden mb-2">
                         <div class="text-sm text-gray-600 bg-indigo-50 border border-indigo-100 rounded-lg px-3 py-2 flex items-center gap-2">
                            <svg class="animate-pulse h-4 w-4 text-indigo-500" fill="currentColor" viewBox="0 0 20 20">
                                <path d="M10 2a6 6 0 00-6 6v3.586l-.707.707A1 1 0 004 14h12a1 1 0 00.707-1.707L16 11.586V8a6 6 0 00-6-6zM10 18a3 3 0 01-3-3h6a3 3 0 01-3 3z" />
                            </svg>
                            æ­£åœ¨ä½¿ç”¨ Gemini TTS æ¨¡å‹ (Kore Voice)
                         </div>
                    </div>

                    <div class="flex gap-2 mt-2">
                        <button id="speakBtn" onclick="speakHandler()" class="flex-1 bg-green-600 hover:bg-green-700 text-white font-medium py-2 px-4 rounded-lg transition shadow-md shadow-green-100 flex justify-center items-center gap-2">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15.536 8.464a5 5 0 010 7.072m2.828-9.9a9 9 0 010 12.728M5.586 15H4a1 1 0 01-1-1v-4a1 1 0 011-1h1.586l4.707-4.707C10.923 3.663 12 4.109 12 5v14c0 .891-1.077 1.337-1.707.707L5.586 15z" />
                            </svg>
                            <span id="speakBtnText">æœ—è¯»</span>
                        </button>
                        <button id="stopBtn" onclick="stopHandler()" class="bg-red-50 hover:bg-red-100 text-red-600 font-medium py-2 px-4 rounded-lg transition border border-red-100 flex justify-center items-center">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 10a1 1 0 011-1h4a1 1 0 011 1v4a1 1 0 01-1 1h-4a1 1 0 01-1-1v-4z" />
                            </svg>
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- æ’­æ”¾å™¨ (éšè—) -->
    <audio id="audioPlayer" class="hidden"></audio>

    <script>
        // --- å…¨å±€å˜é‡ä¸é…ç½® ---
        const els = {
            dropZone: document.getElementById('dropZone'),
            fileInput: document.getElementById('fileInput'),
            imagePreview: document.getElementById('imagePreview'),
            uploadPrompt: document.getElementById('uploadPrompt'),
            reuploadOverlay: document.getElementById('reuploadOverlay'),
            recognizeBtn: document.getElementById('recognizeBtn'),
            aiRecognizeBtn: document.getElementById('aiRecognizeBtn'), // æ–°å¢
            resultText: document.getElementById('resultText'),
            progressContainer: document.getElementById('progressContainer'),
            progressBar: document.getElementById('progressBar'),
            statusText: document.getElementById('statusText'),
            progressPercent: document.getElementById('progressPercent'),
            voiceSelect: document.getElementById('voiceSelect'),
            langSelect: document.getElementById('langSelect'),
            settingsModal: document.getElementById('settingsModal'),
            apiKeyInput: document.getElementById('apiKeyInput'),
            aiBadge: document.getElementById('aiBadge'),
            audioPlayer: document.getElementById('audioPlayer'),
            localVoiceControls: document.getElementById('localVoiceControls'),
            aiVoiceControls: document.getElementById('aiVoiceControls'),
            engineLocalBtn: document.getElementById('engineLocalBtn'),
            engineAiBtn: document.getElementById('engineAiBtn'),
            speakBtn: document.getElementById('speakBtn'),
            speakBtnText: document.getElementById('speakBtnText')
        };

        let selectedFile = null;
        let selectedFileDataUrl = null; // å­˜å‚¨ Base64
        let synth = window.speechSynthesis;
        let localVoices = [];
        let currentEngine = 'local';
        
        let userApiKey = localStorage.getItem('gemini_api_key') || '';
        const envApiKey = (typeof apiKey !== 'undefined' && apiKey) ? apiKey : '';

        function getApiKey() { return userApiKey || envApiKey; }

        function checkApiKey() {
            if (getApiKey()) {
                els.aiBadge.classList.remove('hidden');
                els.apiKeyInput.value = userApiKey;
            } else {
                els.aiBadge.classList.add('hidden');
            }
        }
        checkApiKey();

        // --- è®¾ç½®ç›¸å…³ ---
        function toggleSettings() { els.settingsModal.classList.toggle('hidden'); }

        function saveApiKey() {
            const key = els.apiKeyInput.value.trim();
            if (key) {
                userApiKey = key;
                localStorage.setItem('gemini_api_key', key);
                checkApiKey();
                toggleSettings();
                showToast("API Key å·²ä¿å­˜", "success");
            } else {
                showToast("è¯·è¾“å…¥æœ‰æ•ˆçš„ Key", "error");
            }
        }

        // --- æ–‡ä»¶å¤„ç†é€»è¾‘ ---
        const handleFile = (file) => {
            if (!file || !file.type.startsWith('image/')) return;
            selectedFile = file;
            const reader = new FileReader();
            reader.onload = (e) => {
                selectedFileDataUrl = e.target.result; // ä¿å­˜ Base64 ç”¨äº AI
                els.imagePreview.src = selectedFileDataUrl;
                els.imagePreview.classList.remove('hidden');
                els.reuploadOverlay.classList.remove('hidden');
                els.uploadPrompt.classList.add('hidden');
                els.recognizeBtn.disabled = false;
                els.aiRecognizeBtn.disabled = false;
                els.resultText.value = '';
                els.progressContainer.classList.add('hidden');
            };
            reader.readAsDataURL(file);
        };

        els.fileInput.addEventListener('change', (e) => handleFile(e.target.files[0]));
        ['dragenter', 'dragover'].forEach(e => els.dropZone.addEventListener(e, (ev) => { ev.preventDefault(); els.dropZone.classList.add('drag-active'); }));
        ['dragleave', 'drop'].forEach(e => els.dropZone.addEventListener(e, (ev) => { ev.preventDefault(); els.dropZone.classList.remove('drag-active'); }));
        els.dropZone.addEventListener('drop', (e) => handleFile(e.dataTransfer.files[0]));

        // --- æ–¹å¼ A: æœ¬åœ° OCR ---
        function smartFormat(text) {
            if (!text) return "";
            let formatted = text.replace(/\s+/g, ' ');
            formatted = formatted.replace(/([^\x00-\xff])\s+([^\x00-\xff])/g, '$1$2');
            return formatted.trim();
        }

        els.recognizeBtn.addEventListener('click', async () => {
            if (!selectedFile) return;
            els.recognizeBtn.disabled = true;
            els.aiRecognizeBtn.disabled = true;
            
            try {
                const { data: { text } } = await Tesseract.recognize(selectedFile, els.langSelect.value, {
                    logger: m => {
                        if (m.status === 'recognizing text' || m.status.includes('loading')) {
                            els.progressContainer.classList.remove('hidden');
                            els.statusText.innerText = m.status === 'recognizing text' ? 'æœ¬åœ°å¼•æ“è¯†åˆ«ä¸­...' : 'åŠ è½½ç¦»çº¿æ¨¡å‹...';
                            const pct = Math.floor(m.progress * 100);
                            els.progressPercent.innerText = pct + '%';
                            els.progressBar.style.width = pct + '%';
                        }
                    }
                });
                els.resultText.value = smartFormat(text) || "æœ¬åœ°å¼•æ“æœªè¯†åˆ«å‡ºæ–‡å­—ï¼Œè¯·å°è¯• AI è¯†å›¾ã€‚";
            } catch (err) {
                els.resultText.value = "æœ¬åœ°è¯†åˆ«å‡ºé”™: " + err.message;
            } finally {
                els.recognizeBtn.disabled = false;
                els.aiRecognizeBtn.disabled = false;
                setTimeout(() => els.progressContainer.classList.add('hidden'), 1500);
            }
        });

        // --- æ–¹å¼ B: AI è¯†å›¾ (Gemini Vision) ---
        els.aiRecognizeBtn.addEventListener('click', async () => {
            if (!selectedFileDataUrl) return;
            const key = getApiKey();
            if (!key) return toggleSettings();

            els.recognizeBtn.disabled = true;
            els.aiRecognizeBtn.disabled = true;
            setLoading(true, "Gemini æ­£åœ¨è§‚å¯Ÿå›¾ç‰‡...");

            try {
                // ç§»é™¤ base64 å¤´éƒ¨ (data:image/png;base64,)
                const base64Data = selectedFileDataUrl.split(',')[1];
                const mimeType = selectedFile.type;

                const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
                
                const response = await fetch(url, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        contents: [{
                            parts: [
                                { text: "Please extract all text from this image exactly as it appears. If there are tables or structures, represent them clearly. Do not add any conversational text like 'Here is the text'. Just output the raw text content." },
                                { inlineData: { mimeType: mimeType, data: base64Data } }
                            ]
                        }]
                    })
                });

                if (!response.ok) throw new Error("API è¯·æ±‚å¤±è´¥");
                const data = await response.json();
                const text = data.candidates?.[0]?.content?.parts?.[0]?.text || "æœªè¯†åˆ«åˆ°æ–‡å­—";
                
                els.resultText.value = text.trim();
                showToast("AI è¯†åˆ«å®Œæˆ", "success");

            } catch (e) {
                els.resultText.value = els.resultText.dataset.original || "";
                showToast("AI è¯†å›¾å¤±è´¥: " + e.message, "error");
            } finally {
                setLoading(false);
                els.recognizeBtn.disabled = false;
                els.aiRecognizeBtn.disabled = false;
            }
        });

        // --- AI æ–‡æœ¬å¤„ç† (çº é”™/ç¿»è¯‘/æ‘˜è¦) ---
        async function callGeminiText(prompt) {
            const key = getApiKey();
            if (!key) { toggleSettings(); throw new Error("è¯·è®¾ç½® Key"); }
            const url = `https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-09-2025:generateContent?key=${key}`;
            const response = await fetch(url, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ contents: [{ parts: [{ text: prompt }] }] })
            });
            if (!response.ok) throw new Error("è¯·æ±‚å¤±è´¥");
            const data = await response.json();
            return data.candidates[0].content.parts[0].text;
        }

        function setLoading(isLoading, text = "") {
            if (isLoading) {
                const originalVal = els.resultText.value;
                if (!els.resultText.dataset.original) els.resultText.dataset.original = originalVal;
                els.resultText.value = "âœ¨ AI æ­£åœ¨æ€è€ƒä¸­...\n" + text;
                els.resultText.disabled = true;
            } else {
                els.resultText.disabled = false;
            }
        }

        async function aiCorrect() {
            const text = els.resultText.value;
            if (!text || text.includes("âœ¨")) return showToast("è¯·å…ˆè¯†åˆ«æ–‡å­—", "error");
            setLoading(true, "æ­£åœ¨ä¿®å¤...");
            try {
                const res = await callGeminiText(`è¯·ä¿®å¤ä»¥ä¸‹ OCR ç»“æœä¸­çš„é”™è¯¯ï¼š\n\n"${text}"`);
                els.resultText.value = res.trim();
            } catch (e) { els.resultText.value = els.resultText.dataset.original; showToast(e.message, "error"); }
            finally { setLoading(false); }
        }

        async function aiTranslate() {
            const text = els.resultText.value;
            if (!text || text.includes("âœ¨")) return showToast("è¯·å…ˆè¯†åˆ«æ–‡å­—", "error");
            setLoading(true, "æ­£åœ¨ç¿»è¯‘...");
            try {
                const hasChinese = /[\u4e00-\u9fa5]/.test(text);
                const target = hasChinese ? "English" : "Simplified Chinese";
                const res = await callGeminiText(`Translate to ${target}:\n\n"${text}"`);
                els.resultText.value = res.trim();
            } catch (e) { els.resultText.value = els.resultText.dataset.original; showToast(e.message, "error"); }
            finally { setLoading(false); }
        }

        async function summarize() {
            const text = els.resultText.value;
            if (!text || text.includes("âœ¨")) return showToast("è¯·å…ˆè¯†åˆ«æ–‡å­—", "error");
            setLoading(true, "æ­£åœ¨æ‘˜è¦...");
            try {
                const res = await callGeminiText(`ç”Ÿæˆä¸­æ–‡æ‘˜è¦ï¼š\n\n"${text}"`);
                els.resultText.value = text + "\n\n--- âœ¨ AI æ‘˜è¦ ---\n" + res.trim();
            } catch (e) { els.resultText.value = els.resultText.dataset.original; showToast(e.message, "error"); }
            finally { setLoading(false); }
        }

        // --- TTS é€»è¾‘ ---
        function setEngine(engine) {
            currentEngine = engine;
            if (engine === 'local') {
                els.engineLocalBtn.className = "px-3 py-1 text-xs rounded-md font-medium transition-colors bg-blue-100 text-blue-700";
                els.engineAiBtn.className = "px-3 py-1 text-xs rounded-md font-medium text-gray-500 hover:text-gray-900 transition-colors flex items-center gap-1";
                els.localVoiceControls.classList.remove('hidden');
                els.aiVoiceControls.classList.add('hidden');
            } else {
                if (!getApiKey()) return toggleSettings();
                els.engineLocalBtn.className = "px-3 py-1 text-xs rounded-md font-medium text-gray-500 hover:text-gray-900 transition-colors";
                els.engineAiBtn.className = "px-3 py-1 text-xs rounded-md font-medium bg-gradient-to-r from-indigo-500 to-pink-500 text-white shadow-sm flex items-center gap-1";
                els.localVoiceControls.classList.add('hidden');
                els.aiVoiceControls.classList.remove('hidden');
            }
        }
        window.setEngine = setEngine;

        function initLocalVoices() {
            localVoices = synth.getVoices();
            els.voiceSelect.innerHTML = '';
            const zh = localVoices.filter(v => v.lang.includes('zh') || v.lang.includes('CN'));
            const en = localVoices.filter(v => !v.lang.includes('zh'));
            const add = (v, p) => { const o = document.createElement('option'); o.text = `${v.name}`; o.value = v.name; p.appendChild(o); };
            if (zh.length) { const g = document.createElement('optgroup'); g.label = "ä¸­æ–‡"; zh.forEach(v => add(v, g)); els.voiceSelect.appendChild(g); els.voiceSelect.value = zh[0].name; }
            if (en.length) { const g = document.createElement('optgroup'); g.label = "å…¶ä»–"; en.forEach(v => add(v, g)); els.voiceSelect.appendChild(g); }
        }
        speechSynthesis.onvoiceschanged = initLocalVoices;
        initLocalVoices();

        async function speakHandler() {
            const text = els.resultText.value;
            if (!text) return showToast("æ— å†…å®¹", "error");

            if (currentEngine === 'local') {
                if (synth.speaking) synth.cancel();
                const u = new SpeechSynthesisUtterance(text);
                const v = localVoices.find(v => v.name === els.voiceSelect.value);
                if (v) u.voice = v;
                u.onstart = () => { els.speakBtn.disabled = true; els.speakBtnText.innerText = "æœ—è¯»ä¸­..."; };
                u.onend = () => { els.speakBtn.disabled = false; els.speakBtnText.innerText = "æœ—è¯»"; };
                synth.speak(u);
            } else {
                const key = getApiKey();
                if (!key) return toggleSettings();
                els.speakBtn.disabled = true;
                els.speakBtnText.innerText = "ç”Ÿæˆè¯­éŸ³...";
                try {
                    const res = await fetch(`https://generativelanguage.googleapis.com/v1beta/models/gemini-2.5-flash-preview-tts:generateContent?key=${key}`, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            contents: [{ parts: [{ text: text }] }],
                            generationConfig: { responseModalities: ["AUDIO"], speechConfig: { voiceConfig: { prebuiltVoiceConfig: { voiceName: "Kore" } } } }
                        })
                    });
                    if (!res.ok) throw new Error("TTS å¤±è´¥");
                    const d = await res.json();
                    const audio = d.candidates?.[0]?.content?.parts?.[0]?.inlineData?.data;
                    if (!audio) throw new Error("æ— éŸ³é¢‘");
                    
                    const pcm = base64ToArrayBuffer(audio);
                    const wav = createWavFile(pcm, 24000);
                    const blob = new Blob([wav], { type: 'audio/wav' });
                    const url = URL.createObjectURL(blob);
                    
                    els.audioPlayer.src = url;
                    els.audioPlayer.play();
                    els.speakBtnText.innerText = "AI æ­£åœ¨æœ—è¯»...";
                    els.audioPlayer.onended = () => { els.speakBtn.disabled = false; els.speakBtnText.innerText = "æœ—è¯»"; URL.revokeObjectURL(url); };
                } catch (e) { console.error(e); showToast(e.message, "error"); els.speakBtn.disabled = false; els.speakBtnText.innerText = "æœ—è¯»"; }
            }
        }

        function stopHandler() {
            if (currentEngine === 'local') synth.cancel(); else { els.audioPlayer.pause(); els.audioPlayer.currentTime = 0; }
            els.speakBtn.disabled = false;
            els.speakBtnText.innerText = "æœ—è¯»";
        }

        // --- Utils ---
        function copyText() { els.resultText.select(); document.execCommand('copy'); showToast("å·²å¤åˆ¶", "success"); }
        function clearText() { if(confirm("æ¸…ç©ºï¼Ÿ")) els.resultText.value = ""; }
        function showToast(msg, type="info") {
            const t = document.createElement('div');
            t.className = `fixed bottom-5 left-1/2 transform -translate-x-1/2 px-4 py-2 rounded-lg shadow-lg text-white text-sm z-50 ${type === 'error' ? 'bg-red-500' : 'bg-gray-800'}`;
            t.innerText = msg;
            document.body.appendChild(t);
            setTimeout(() => t.remove(), 3000);
        }
        function base64ToArrayBuffer(base64) {
            const s = window.atob(base64); const l = s.length; const b = new Uint8Array(l);
            for (let i=0; i<l; i++) b[i] = s.charCodeAt(i); return b.buffer;
        }
        function createWavFile(samples, rate) {
            const b = new ArrayBuffer(44 + samples.byteLength); const v = new DataView(b);
            const w = (o, s) => { for (let i=0; i<s.length; i++) v.setUint8(o+i, s.charCodeAt(i)); };
            w(0, 'RIFF'); v.setUint32(4, 36+samples.byteLength, true); w(8, 'WAVE'); w(12, 'fmt ');
            v.setUint32(16, 16, true); v.setUint16(20, 1, true); v.setUint16(22, 1, true);
            v.setUint32(24, rate, true); v.setUint32(28, rate*2, true); v.setUint16(32, 2, true);
            v.setUint16(34, 16, true); w(36, 'data'); v.setUint32(40, samples.byteLength, true);
            new Uint8Array(b, 44).set(new Uint8Array(samples)); return b;
        }

        // Exports
        window.aiCorrect = aiCorrect; window.aiTranslate = aiTranslate; window.summarize = summarize;
        window.copyText = copyText; window.clearText = clearText;
        window.speakHandler = speakHandler; window.stopHandler = stopHandler;
        window.toggleSettings = toggleSettings; window.saveApiKey = saveApiKey;
    </script>
</body>
</html>
